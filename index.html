<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KR.AI ‚Äî Custom AI</title>
<script>document.documentElement.classList.add('js')</script>
<meta name="description" content="Premium single-file site: accounts, PayPal Pro unlock tied to account, local AI chat with history, fully custom."/>
<style>
:root{--bg:#0b1220;--bg2:#0f172a;--glass:#0f1a30cc;--text:#e6eefc;--muted:#9fb0cf;--brand:#5aa0ff;--brand2:#00f5d4;--accent:#a78bfa;--border:#1f2a44;--rad:18px;--shadow:0 10px 30px rgba(0,0,0,.45)}
:root.light{--bg:#f6f9ff;--bg2:#eef3ff;--glass:#ffffffcc;--text:#0b1220;--muted:#4b5568;--brand:#1e66ff;--brand2:#00c2a8;--accent:#7c3aed;--border:#d7def3;--shadow:0 8px 20px rgba(28,43,76,.15)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
.backdrop{position:fixed;inset:0;z-index:-3;pointer-events:none;animation:hue 14s ease-in-out infinite alternate;filter:saturate(115%);
background:radial-gradient(1200px 800px at 20% -10%, rgba(90,160,255,.25), transparent 60%),
           radial-gradient(900px 600px at 90% 10%, rgba(0,245,212,.18), transparent 60%),
           radial-gradient(1000px 700px at 50% 110%, rgba(167,139,250,.16), transparent 60%),
           linear-gradient(180deg, rgba(15,23,42,.9), rgba(11,18,32,1))}
@keyframes hue{from{filter:hue-rotate(0) saturate(110%)}to{filter:hue-rotate(25deg) saturate(125%)}}
#stars{position:fixed;inset:0;z-index:-2;opacity:.35}
.orb{position:absolute;border-radius:50%;filter:blur(40px);opacity:.35;z-index:-1}
.orb.one{top:-120px;left:-80px;width:380px;height:380px;background:radial-gradient(circle at 30% 30%,#5aa0ff,transparent 60%)}
.orb.two{right:-120px;top:20vh;width:420px;height:420px;background:radial-gradient(circle at 60% 40%,#00f5d4,transparent 60%)}

.wrap{max-width:1240px;margin:0 auto;padding:0 24px}
header{position:sticky;top:0;z-index:60;backdrop-filter:saturate(160%) blur(10px);background:linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.55));border-bottom:1px solid var(--border)}
.nav{display:flex;align-items:center;justify-content:space-between;height:78px}
.brand{display:flex;align-items:center;gap:14px;font-weight:800;letter-spacing:.3px;font-size:20px}
.brand .ring{position:relative;height:56px;width:56px;border-radius:14px;background:linear-gradient(180deg,#101b33,#0b1427);display:grid;place-items:center;box-shadow:0 6px 20px rgba(0,0,0,.35);overflow:hidden}
.brand .ring::after{content:"";position:absolute;inset:-2px;border-radius:16px;padding:2px;background:linear-gradient(90deg,var(--brand),var(--brand2));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.brand img{height:34px;width:34px;border-radius:8px;object-fit:contain}
.nav a,.nav button.link{color:var(--text);text-decoration:none;margin-left:22px;font-weight:700;opacity:.9;background:none;border:0;cursor:pointer}
.nav a:hover,.nav button.link:hover{opacity:1}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.05);font-size:12px}

.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:14px;border:1px solid transparent;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#07111f;font-weight:800;box-shadow:var(--shadow);text-decoration:none;position:relative;overflow:hidden;transition:transform .15s ease}
.btn:hover{transform:translateY(-2px)}
.btn::after{content:"";position:absolute;inset:-1px;background:linear-gradient(90deg,rgba(255,255,255,.4),transparent 40%,transparent);transform:translateX(-100%);transition:transform .8s cubic-bezier(.19,1,.22,1)}
.btn:hover::after{transform:translateX(0)}
.btn.outline{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn.small{padding:8px 12px;border-radius:10px;font-weight:700}

section{padding:90px 0}
.eyebrow{display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.06);border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-size:13px;color:var(--muted)}
.hero{text-align:center}
.hero h1{margin:18px auto 10px;font-size:clamp(42px,6.3vw,74px);line-height:1.05;letter-spacing:-.02em;max-width:980px}
.grad{background:linear-gradient(90deg,var(--brand),var(--brand2),var(--accent));-webkit-background-clip:text;background-clip:text;color:transparent}
.hero p{margin:0 auto;max-width:860px;color:var(--muted);font-size:clamp(16px,1.6vw,20px)}
.hero-cta{margin-top:26px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

.trust{margin:64px auto 0;max-width:1100px;padding:20px;border:1px solid var(--border);border-radius:var(--rad);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
.trust .row{display:grid;grid-template-columns:repeat(6,1fr);gap:20px;align-items:center}
.trust img{width:100%;height:44px;object-fit:contain;filter:grayscale(1) contrast(1.1) opacity(.9)}

.section-title{font-size:36px;text-align:center;margin:0 auto 16px;letter-spacing:-.01em}
.section-lead{max-width:780px;margin:0 auto;text-align:center;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:36px}
.card{background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);padding:26px;box-shadow:var(--shadow);transform:translateY(0);transition:transform .35s ease,border-color .35s ease,box-shadow .35s ease}
.card:hover{transform:translateY(-6px);border-color:rgba(90,160,255,.45);box-shadow:0 16px 40px rgba(0,0,0,.5)}
.icon{display:inline-flex;align-items:center;justify-content:center;height:48px;width:48px;border-radius:12px;background:linear-gradient(180deg,rgba(90,160,255,.2),rgba(0,245,212,.15));border:1px solid var(--border);margin-bottom:12px}

.chat-wrap{display:grid;grid-template-columns:1.15fr .85fr;gap:26px;align-items:stretch;margin-top:40px}
.chat{display:flex;flex-direction:column;background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);box-shadow:var(--shadow);overflow:hidden}
.chat-header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
.chat-header img{height:28px;width:28px;border-radius:8px}
.chat-header .title{font-weight:800}
.model-select{margin-left:auto;display:flex;gap:10px;align-items:center}
.select{appearance:none;background:transparent;color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px}
.msgs{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:14px}
.msg{display:flex;gap:12px}
.avatar{flex:0 0 36px;height:36px;width:36px;border-radius:10px;background:#0b162a;border:1px solid var(--border);display:flex;align-items:center;justify-content:center}
.msg.user .avatar{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#0b1220;font-weight:800}
.bubble{background:#0b162acc;border:1px solid var(--border);border-radius:14px;padding:12px 14px;max-width:80%}
.msg.user .bubble{background:linear-gradient(180deg,#12213d,#122547)}
.msg.assistant .avatar{background:#0b162a url('logo.png') center/cover no-repeat}
.composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02))}
.composer textarea{flex:1;min-height:46px;max-height:160px;resize:vertical;background:#0b162a;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 14px}
.composer button{white-space:nowrap}
.hint{font-size:12px;color:var(--muted);padding:0 12px 12px}
.panel{background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);box-shadow:var(--shadow);padding:22px}
.panel h4{margin:0 0 8px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--muted);margin:4px 6px 0 0;cursor:pointer}

.products{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:36px}
.prod{background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);padding:22px;box-shadow:var(--shadow)}
.prod h4{margin:8px 0 6px}
.price{font-size:22px;font-weight:800}

.faq{max-width:1000px;margin:30px auto 0}
details{background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:12px}
details summary{cursor:pointer;font-weight:700}
details[open]{border-color:rgba(90,160,255,.45)}
footer{border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));padding:28px 0;color:var(--muted)}
.foot{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}

.reveal{opacity:1;transform:none}
.js .reveal{opacity:0;transform:translateY(14px);transition:opacity .6s ease,transform .6s ease}
.js .reveal.visible{opacity:1;transform:none}
.loader{width:100%;height:6px;background:#0b162a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.loader>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .2s ease}
.banner{background:#162136;border:1px solid var(--border);padding:12px 14px;border-radius:12px;margin:10px 0;color:#cbd5e1}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#0b162a;border:1px solid var(--border);padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);display:none}
.toast.show{display:block}

/* Auth modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:80}
.modal .box{background:var(--glass);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px;min-width:320px;max-width:420px}
.modal .box h3{margin:0 0 8px}
.modal input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b162a;color:var(--text);margin:8px 0}
.modal .tabs{display:flex;gap:8px;margin-bottom:8px}
.modal .tabs button{flex:1} .right{display:flex;gap:8px;align-items:center}

/* Responsive */
@media (max-width:980px){.grid{grid-template-columns:1fr}.chat-wrap{grid-template-columns:1fr}.trust .row{grid-template-columns:repeat(3,1fr)}.products{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="backdrop"></div>
  <div class="orb one"></div><div class="orb two"></div>
  <canvas id="stars"></canvas>

  <header>
    <div class="wrap nav">
      <div class="brand">
        <div class="ring"><img src="logo.png" alt="KR.AI"/></div>
        <span>KR.AI</span>
      </div>
      <nav class="right">
        <a href="#features">Features</a>
        <a href="#chat">AI Chat</a>
        <a href="#shop">Shop</a>
        <a href="#faq">FAQ</a>
        <span id="proBadge" class="badge" style="display:none">‚≠ê Pro account</span>
        <button id="authBtn" class="link">Sign in</button>
        <a id="modeToggle" href="#" aria-label="Toggle theme" style="margin-left:6px">üåô</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero wrap">
      <span class="eyebrow reveal">Fully custom. Built from zero.</span>
      <h1 class="reveal">A <span class="grad">premium AI experience</span> by <b>Karol Rutkowski</b></h1>
      <p class="reveal">Glass UI, parallax, micro-interactions and real token streaming from a local model. No external brand names anywhere.</p>
      <div class="hero-cta reveal">
        <a class="btn" href="#chat">Start AI Chat</a>
        <a class="btn outline" href="#features">Explore features</a>
      </div>
      <div id="gpuBanner" class="wrap" style="max-width:820px;margin:20px auto 0"></div>

      <div class="trust reveal" style="margin-top:28px">
        <div class="row">
          <img src="logo.png" alt="logo"/><img src="logo.png" alt="logo"/><img src="logo.png" alt="logo"/>
          <img src="logo.png" alt="logo"/><img src="logo.png" alt="logo"/><img src="logo.png" alt="logo"/>
        </div>
      </div>
    </section>

    <!-- FEATURES -->
    <section id="features" class="wrap">
      <h2 class="section-title reveal">Everything that matters</h2>
      <p class="section-lead reveal">100% custom interface. Local model with graceful demo fallback.</p>
      <div class="grid">
        <article class="card reveal"><div class="icon">‚ö°</div><h3>Real-time streaming</h3><p>Answers stream token-by-token into the chat.</p></article>
        <article class="card reveal"><div class="icon">üé®</div><h3>Max-premium look</h3><p>Glass cards, gradient rings, parallax orbs, subtle 3D tilt and reveals.</p></article>
        <article class="card reveal"><div class="icon">üß†</div><h3>Custom engines</h3><p>Core (fast), Ultra (quality), Fusion (two-pass refine). Switch in the header.</p></article>
      </div>
    </section>

    <!-- CHAT -->
    <section id="chat" class="wrap">
      <h2 class="section-title reveal">AI Chat</h2>
      <p class="section-lead reveal">Runs locally in your browser with WebGPU. If unavailable, it switches to Demo Mode so the UI always works.</p>

      <div class="chat-wrap">
        <div class="chat reveal" id="chatBox">
          <div class="chat-header">
            <img src="logo.png" alt="KR"/>
            <div class="title">KR Assistant</div>
            <div class="model-select">
              <label class="muted" for="engine">Engine</label>
              <select id="engine" class="select">
                <option value="core" selected>Core (Local Fast)</option>
                <option value="ultra" data-pro>Ultra (Local Quality)</option>
                <option value="fusion" data-pro>Fusion (Two-Pass)</option>
              </select>
              <label class="muted" for="model">Model</label>
              <select id="model" class="select">
                <option value="llama1b" selected>Llama-3.2-1B (light)</option>
              </select>
            </div>
          </div>

          <div style="padding:12px 18px;border-bottom:1px solid var(--border)">
            <div class="loader"><i id="progressBar"></i></div>
            <div id="modelStatus" class="hint">Model not loaded yet.</div>
          </div>

          <div class="msgs" id="msgs"></div>

          <div class="composer">
            <textarea id="input" placeholder="Type your message‚Ä¶ (Shift+Enter = new line)"></textarea>
            <button class="btn" id="send">Send</button>
            <button class="btn outline" id="stop" title="Stop">Stop</button>
          </div>
          <div class="hint">Custom behavior: ask ‚Äúwho created you / who made you‚Äù to see your special answer.</div>
        </div>

        <aside class="panel reveal" id="historyPanel">
          <h4><img src="logo.png" alt="logo" class="mini" style="height:20px;width:20px;border-radius:6px;object-fit:contain">  Chat History</h4>
          <div id="threads"></div>
          <div style="margin-top:12px"><button class="btn small outline" id="newChat">New chat</button></div>
          <h4 style="margin-top:16px">Quick prompts</h4>
          <div>
            <span class="chip ex">Write a premium hero section for ‚ÄúKR.AI‚Äù.</span>
            <span class="chip ex">Give 6 catchy taglines.</span>
            <span class="chip ex">Explain growth mindset in 3 bullets.</span>
            <span class="chip ex">Draft a friendly payment reminder email.</span>
          </div>
        </aside>
      </div>
    </section>

    <!-- SHOP -->
    <section id="shop" class="wrap">
      <h2 class="section-title reveal">Shop ¬∑ Upgrade to Pro</h2>
      <p class="section-lead reveal">Buy once. Pro unlocks **Ultra** and **Fusion** engines and extra UI themes for your account.</p>

      <div class="products">
        <div class="prod reveal">
          <div class="badge">Starter</div>
          <h4>Core Access</h4>
          <p>Use the fast local engine for personal work.</p>
          <div class="price">Free</div>
          <div style="margin-top:10px"><a class="btn small outline" href="#chat">Use Core</a></div>
        </div>

        <div class="prod reveal">
          <div class="badge">Pro</div>
          <h4>Ultra + Fusion</h4>
          <p>Unlock both premium engines and themes. One-time purchase.</p>
          <div class="price">‚Ç¨9.99</div>
          <div class="shop" style="margin-top:10px">
            <form id="paypalForm" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
              <input type="hidden" name="cmd" value="_xclick">
              <input type="hidden" name="business" value="02rrutkowski@gmail.com">
              <input type="hidden" name="item_name" value="KR.AI Pro Access">
              <input type="hidden" name="amount" value="9.99">
              <input type="hidden" name="currency_code" value="EUR">
              <input type="hidden" name="return" id="ppReturn" value="">
              <input type="hidden" name="cancel_return" id="ppCancel" value="">
              <button class="btn small" type="submit">Buy with PayPal</button>
            </form>
          </div>
        </div>

        <div class="prod reveal">
          <div class="badge">Add-ons</div>
          <h4>Brand Kit</h4>
          <p>Logo variants (SVG/PNG), palette & type presets by KR.</p>
          <div class="price">Coming soon</div>
          <button class="btn small outline" disabled>Waitlist</button>
        </div>
      </div>

      <div class="banner" style="margin-top:14px">
        For automatic unlock after PayPal, open this file via a local web server (e.g. <code>python -m http.server 8080</code>).
        We return to <code>?paid=1</code> and bind Pro to the signed-in account.
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" class="wrap">
      <h2 class="section-title reveal">FAQ</h2>
      <div class="faq">
        <details class="reveal"><summary>Does this use other AI providers?</summary><div>No. It‚Äôs a custom interface that runs a small open-source model locally with WebGPU. No brand names in the UI.</div></details>
        <details class="reveal"><summary>What if WebGPU isn‚Äôt available?</summary><div>It switches to Demo Mode (simulated streaming) so you can still test everything.</div></details>
        <details class="reveal"><summary>How does Pro unlock work?</summary><div>You must be signed in. After PayPal returns with <code>?paid=1</code>, Pro is saved to your account and persists across reloads on this device.</div></details>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap foot">
      <div class="foot-left"><img src="logo.png" class="mini" alt="logo" style="height:24px;width:24px;border-radius:6px;object-fit:contain"/><span>¬© 2025 KR.AI ‚Äî built by Karol Rutkowski</span></div>
      <div class="foot-right"><a href="#">Privacy</a><a href="#">Terms</a><a href="#">Contact</a></div>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="box">
      <h3 id="authTitle">Sign in</h3>
      <div class="tabs">
        <button class="btn small outline" id="tabSignIn">Sign in</button>
        <button class="btn small outline" id="tabSignUp">Create account</button>
      </div>
      <div id="signInForm">
        <input id="siEmail" type="email" placeholder="Email"/>
        <input id="siPass" type="password" placeholder="Password"/>
        <button class="btn" id="doSignIn">Sign in</button>
      </div>
      <div id="signUpForm" style="display:none">
        <input id="suName" type="text" placeholder="Full name"/>
        <input id="suEmail" type="email" placeholder="Email"/>
        <input id="suPass" type="password" placeholder="Password (min 6)"/>
        <button class="btn" id="doSignUp">Create account</button>
      </div>
      <div style="margin-top:8px;text-align:right"><button class="btn small outline" id="closeAuth">Close</button></div>
    </div>
  </div>

<script>
/* ===== Decor / Basics ===== */
(function(){
  const c=document.getElementById('stars'); const dpr=window.devicePixelRatio||1; const ctx=c.getContext('2d');
  let w,h,stars=[]; const N=140; function resize(){w=innerWidth;h=innerHeight;c.width=w*dpr;c.height=h*dpr;c.style.width=w+'px';c.style.height=h+'px';ctx.setTransform(dpr,0,0,dpr,0,0)} resize(); addEventListener('resize',resize);
  for(let i=0;i<N;i++) stars.push({x:Math.random()*w,y:Math.random()*h,s:Math.random()*1.6+0.2,v:Math.random()*0.15+0.02});
  (function loop(){ctx.clearRect(0,0,w,h); ctx.globalAlpha=.9; for(const st of stars){ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fill(); st.y+=st.v; if(st.y>h+5){st.y=-5; st.x=Math.random()*w}} requestAnimationFrame(loop)})();
})();
const io=new IntersectionObserver((es)=>es.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible'); io.unobserve(e.target)}}),{threshold:.12});
document.querySelectorAll('.reveal').forEach(el=>io.observe(el));
document.getElementById('modeToggle')?.addEventListener('click',(e)=>{e.preventDefault();document.documentElement.classList.toggle('light');e.currentTarget.textContent=document.documentElement.classList.contains('light')?'üåû':'üåô'});

const toast = document.getElementById('toast');
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2500); }

/* ===== Simple Account System (localStorage demo) ===== */
const STORE='krai_users_v1', SESSION='krai_session_v1';
function loadUsers(){try{return JSON.parse(localStorage.getItem(STORE))||{}}catch{return{}}}
function saveUsers(u){localStorage.setItem(STORE, JSON.stringify(u))}
function getSession(){try{return JSON.parse(localStorage.getItem(SESSION))||null}catch{return null}}
function setSession(s){localStorage.setItem(SESSION, JSON.stringify(s))}
async function sha256(txt){const enc=new TextEncoder().encode(txt);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')}
function currentUser(){const s=getSession(); if(!s) return null; const u=loadUsers()[s.email]; return u?{email:s.email, ...u}:null}
function saveUser(email, data){const all=loadUsers(); all[email]=data; saveUsers(all)}
function requireAuth(){const u=currentUser(); if(!u){openAuth(); return false} return true}

/* Modal */
const authModal=document.getElementById('authModal');
function openAuth(){authModal.style.display='flex';}
function closeAuth(){authModal.style.display='none';}
document.getElementById('authBtn').addEventListener('click',()=>{
  const u=currentUser();
  if(u){ // show account dropdown quick actions
    if(confirm(`Signed in as ${u.email}\n\nSign out?`)){ setSession(null); document.getElementById('authBtn').textContent='Sign in'; reflectPro(false); showToast('Signed out'); }
    renderThreads(); // refresh
  } else openAuth();
});
document.getElementById('closeAuth').onclick=closeAuth;
const tabIn=document.getElementById('tabSignIn'), tabUp=document.getElementById('tabSignUp');
const signInForm=document.getElementById('signInForm'), signUpForm=document.getElementById('signUpForm'), authTitle=document.getElementById('authTitle');
tabIn.onclick=()=>{signInForm.style.display='block';signUpForm.style.display='none';authTitle.textContent='Sign in'}
tabUp.onclick=()=>{signInForm.style.display='none';signUpForm.style.display='block';authTitle.textContent='Create account'}

document.getElementById('doSignUp').addEventListener('click', async ()=>{
  const name=document.getElementById('suName').value.trim();
  const email=document.getElementById('suEmail').value.trim().toLowerCase();
  const pass=document.getElementById('suPass').value;
  if(!name||!email||pass.length<6){showToast('Fill all fields (password ‚â• 6).');return}
  const users=loadUsers(); if(users[email]){showToast('Account already exists. Sign in.');return}
  users[email]={name, pass:await sha256(pass), pro:false, chats:[], lastChatId:null};
  saveUsers(users); setSession({email}); document.getElementById('authBtn').textContent=email; closeAuth(); showToast('Account created'); reflectPro(false); renderThreads();
});
document.getElementById('doSignIn').addEventListener('click', async ()=>{
  const email=document.getElementById('siEmail').value.trim().toLowerCase();
  const pass=document.getElementById('siPass').value;
  const users=loadUsers(); const u=users[email];
  if(!u){showToast('No account. Create one.');return}
  if(u.pass!==await sha256(pass)){showToast('Wrong password.');return}
  setSession({email}); document.getElementById('authBtn').textContent=email; closeAuth(); showToast('Signed in'); reflectPro(u.pro); renderThreads(); restoreChat();
});

/* ===== Pro unlock (PayPal, auto only, bound to account) ===== */
const proBadge=document.getElementById('proBadge');
function reflectPro(isPro){
  const user=currentUser();
  if(user){ proBadge.style.display = (isPro||user.pro) ? 'inline-flex' : 'none'; }
  document.querySelectorAll('#engine option[data-pro]').forEach(o=>{
    const p = isPro || (user && user.pro);
    o.classList.toggle('lock', !p);
    if(p){ o.textContent = o.textContent.replace(' üîí',''); } else if(!o.textContent.includes('üîí')){ o.textContent += ' üîí'; }
  });
}
const ppForm=document.getElementById('paypalForm');
ppForm.addEventListener('submit',(e)=>{
  const user=currentUser();
  if(!user){ e.preventDefault(); openAuth(); showToast('Sign in before purchase.'); return; }
  const base=(location.origin && location.origin!=='null')? (location.origin+location.pathname) : '';
  document.getElementById('ppReturn').value = base? `${base}?paid=1&acct=${encodeURIComponent(user.email)}` : 'https://example.com?paid=1';
  document.getElementById('ppCancel').value = base? `${base}?paid=0` : 'https://example.com?paid=0';
});
const paid=new URLSearchParams(location.search).get('paid');
const acct=new URLSearchParams(location.search).get('acct');
if(paid==='1' && acct){
  const users=loadUsers(); if(users[acct]){ users[acct].pro=true; saveUsers(users); if(currentUser()?.email===acct) reflectPro(true); showToast('‚úÖ Pro unlocked for your account.'); }
  history.replaceState({},'',location.pathname);
}

/* ===== Chat storage (per account) ===== */
function userData(){const u=currentUser(); if(!u) return null; return loadUsers()[u.email];}
function persistUserData(data){const u=currentUser(); if(!u) return; const all=loadUsers(); all[u.email]=data; saveUsers(all)}
function newThread(title){const data=userData(); if(!data) return null; const id='t'+Date.now(); const thr={id,title,created:Date.now(),msgs:[]}; data.chats.unshift(thr); data.lastChatId=id; persistUserData(data); return thr;}
function getThread(id){const data=userData(); if(!data) return null; return data.chats.find(t=>t.id===id)||null}
function currentThread(){const data=userData(); if(!data) return null; return getThread(data.lastChatId)||null}
function setCurrentThread(id){const data=userData(); if(!data) return; data.lastChatId=id; persistUserData(data)}
function renderThreads(){
  const box=document.getElementById('threads'); if(!box) return;
  const data=userData(); box.innerHTML='';
  if(!data||!data.chats.length){ box.innerHTML='<div class="hint">No chats yet.</div>'; return; }
  data.chats.forEach(t=>{
    const a=document.createElement('a'); a.href="#chat"; a.style.cssText='display:block;padding:8px 10px;border:1px solid var(--border);border-radius:10px;margin-top:6px;text-decoration:none;color:var(--text);background:rgba(255,255,255,.03)';
    a.textContent = t.title || 'Untitled chat';
    a.onclick=(e)=>{e.preventDefault(); setCurrentThread(t.id); renderThreadMessages(); document.getElementById('input').focus();};
    box.appendChild(a);
  });
}
function renderThreadMessages(){
  const t=currentThread(); const msgsEl=document.getElementById('msgs'); msgsEl.innerHTML='';
  if(!t){ msgsEl.innerHTML='<div class="msg assistant"><div class="avatar"></div><div class="bubble">Welcome! Start a new chat from the right panel.</div></div>'; return;}
  t.msgs.forEach(m=>{ const row=document.createElement('div'); row.className='msg '+m.role; const av=document.createElement('div'); av.className='avatar'; const bub=document.createElement('div'); bub.className='bubble'; bub.innerHTML=m.content.replace(/\n/g,'<br>'); row.appendChild(av); row.appendChild(bub); msgsEl.appendChild(row); });
  msgsEl.scrollTop=msgsEl.scrollHeight;
}
function restoreChat(){
  const u=currentUser(); if(!u) return;
  const data=userData(); if(!data) return;
  if(!data.lastChatId && data.chats.length) data.lastChatId=data.chats[0].id;
  persistUserData(data);
  renderThreads(); renderThreadMessages();
  if((getThread(data.lastChatId)||{}).msgs?.length) location.hash='#chat';
}
document.getElementById('newChat').addEventListener('click',()=>{ if(!requireAuth()) return; const thr=newThread('New chat'); renderThreads(); renderThreadMessages(); document.getElementById('input').focus(); });

/* On load: reflect auth UI */
(function initAuthUI(){
  const u=currentUser(); if(u){ document.getElementById('authBtn').textContent=u.email; reflectPro(u.pro); }
  else { document.getElementById('authBtn').textContent='Sign in'; reflectPro(false); }
  restoreChat();
})();

/* ===== GPU banner ===== */
function setBanner(msg){ const el=document.getElementById('gpuBanner'); if(el) el.innerHTML = `<div class="banner">${msg}</div>`; }
if(!('gpu' in navigator)) setBanner("No WebGPU detected ‚Äî Demo Mode enabled. Use Chrome/Edge on a recent GPU for local AI.");
else setBanner("WebGPU detected ‚Äî the model will load when you send the first message.");

/* ===== AI (WebLLM) + Demo fallback ===== */
let engine=null, abort=false, demoMode=false;
const progressBar=document.getElementById('progressBar');
const modelStatus=document.getElementById('modelStatus');
const engineEl=document.getElementById('engine');
const inputEl=document.getElementById('input');
const sendBtn=document.getElementById('send');
const stopBtn=document.getElementById('stop');
function addMsg(role, html){
  const msgsEl=document.getElementById('msgs'); const row=document.createElement('div'); row.className='msg '+role;
  const av=document.createElement('div'); av.className='avatar';
  const bub=document.createElement('div'); bub.className='bubble'; bub.innerHTML=html;
  row.appendChild(av); row.appendChild(bub); msgsEl.appendChild(row); msgsEl.scrollTop=msgsEl.scrollHeight; return bub;
}
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
async function* demoStream(text){ for(let i=0;i<text.length;i++){ if(abort) return; yield text[i]; await sleep(8);} }
function cfg(mode){ if(mode==='core') return {temperature:.7, top_p:.95, max_tokens:512}; if(mode==='ultra') return {temperature:.35, top_p:.9, max_tokens:768}; return {temperature:.5, top_p:.9, max_tokens:640}; }
function isWhoCreatedYou(s){ const q=s.toLowerCase(); return q.includes("who created you")||q.includes("who made you"); }
const CUSTOM_CREATOR_REPLY = `oke and who made you?
I was created by Meta AI, a team of AI researchers at Meta Platforms, Inc. (formerly Facebook) to assist and communicate with users.
(And customized by Karol Rutkowski for this website.)`;

async function ensureEngine(){
  if(engine || demoMode) return;
  if(!('gpu' in navigator)){ demoMode=true; modelStatus.textContent="Demo Mode (no WebGPU)."; progressBar.style.width="100%"; return; }
  try{
    const { CreateMLCEngine } = await import("https://esm.run/@mlc-ai/web-llm");
    const modelId="Llama-3.2-1B-Instruct-q4f16_1-MLC";
    modelStatus.textContent=`Loading model: ${modelId}`;
    const initProgressCallback=(p)=>{ progressBar.style.width=Math.max(8,Math.floor((p.progress||0)*100))+'%'; modelStatus.textContent=p.text||'Loading model‚Ä¶'; };
    engine=await CreateMLCEngine(modelId,{initProgressCallback});
    progressBar.style.width="100%"; modelStatus.textContent="Model loaded. Ready.";
  }catch(e){ demoMode=true; modelStatus.textContent="Demo Mode (offline)."; progressBar.style.width="100%"; }
}
async function* localStream(messages, config){
  const resp=await engine.chat.completions.create({messages, stream:true, temperature:config.temperature, top_p:config.top_p, max_tokens:config.max_tokens});
  for await (const chunk of resp){ const d=chunk?.choices?.[0]?.delta?.content||""; if(d) yield d; }
}

/* send handler with history persist */
async function handleSend(){
  if(!requireAuth()) return;
  let data=userData(); if(!data) return;
  let thr=currentThread(); if(!thr){ thr=newThread('New chat'); data=userData(); }
  const val=inputEl.value.trim(); if(!val) return;
  inputEl.value=''; sendBtn.disabled=true; stopBtn.disabled=false; abort=false;

  thr.title = thr.title==='New chat' && val ? val.slice(0,60) : (thr.title||val.slice(0,60));
  thr.msgs.push({role:'user', content:val, ts:Date.now()}); persistUserData(data);

  addMsg('user', val.replace(/\n/g,'<br>'));
  const out=addMsg('assistant','');

  try{
    await ensureEngine();

    if(isWhoCreatedYou(val)){
      for await (const ch of demoStream(CUSTOM_CREATOR_REPLY)){ if(abort) break; out.textContent+=ch; }
      thr.msgs.push({role:'assistant', content:CUSTOM_CREATOR_REPLY, ts:Date.now()}); persistUserData(data); renderThreads(); return;
    }

    const mode=engineEl.value;
    const isPro=currentUser()?.pro;
    if((mode==='ultra'||mode==='fusion') && !isPro){ const msg="üîí This engine requires Pro. Go to Shop to upgrade."; out.textContent=msg; thr.msgs.push({role:'assistant', content:msg, ts:Date.now()}); persistUserData(data); return; }

    const base=[{role:'system',content:'You are a helpful, concise assistant for a premium website. Keep answers crisp.'},{role:'user',content:val}];

    if(demoMode){
      const demo=`Demo reply (no WebGPU or offline):\n\nYou said: "${val}"\n\nThis is simulated streaming so you can test the UI without providers or keys.`;
      let acc=''; for await (const ch of demoStream(demo)){ if(abort) break; out.textContent+=ch; acc+=ch; }
      thr.msgs.push({role:'assistant', content:acc, ts:Date.now()}); persistUserData(data);
    }else if(mode==='fusion'){
      let acc=''; for await (const ch of localStream(base, cfg('core'))){ if(abort) break; out.textContent+=ch; acc+=ch; }
      if(!abort){ const refine={role:'user',content:'Refine your last answer: clearer, shorter, add bullet tips if useful.'}; out.textContent+="\n\n‚Äî Refining ‚Ä¶ ‚Äî\n"; acc+="\n\n‚Äî Refining ‚Ä¶ ‚Äî\n";
        for await (const ch of localStream([...base,{role:'assistant',content:acc},refine], cfg('ultra'))){ if(abort) break; out.textContent+=ch; acc+=ch; } }
      thr.msgs.push({role:'assistant', content:acc, ts:Date.now()}); persistUserData(data);
    }else{
      let acc=''; for await (const ch of localStream(base, cfg(mode))){ if(abort) break; out.textContent+=ch; acc+=ch; }
      thr.msgs.push({role:'assistant', content:acc, ts:Date.now()}); persistUserData(data);
    }
  }catch(err){
    const msg='‚ö†Ô∏è '+(err?.message||String(err)); out.textContent=msg; thr.msgs.push({role:'assistant', content:msg, ts:Date.now()}); persistUserData(data);
  }finally{
    sendBtn.disabled=false; stopBtn.disabled=true; renderThreads();
  }
}
sendBtn.addEventListener('click', handleSend);
stopBtn.addEventListener('click', ()=>{ abort=true; try{ engine?.interruptGenerate?.(); }catch{} stopBtn.disabled=true; });
inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }});
document.querySelectorAll('.ex').forEach(ch=>ch.addEventListener('click',()=>{ inputEl.value=ch.textContent; inputEl.focus(); }));
</script>
</body>
</html>

