<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KR.AI — Custom AI</title>
<script>document.documentElement.classList.add('js')</script>
<meta name="description" content="Single-file custom site: accounts with avatars, Pro unlock per account, local AI chat with persistent history, premium animated UI."/>
<style>
/* ============= THEME ============= */
:root{
  --bg:#0b1220;--bg2:#0f172a;--glass:#0f1a30cc;--text:#e6eefc;--muted:#9fb0cf;
  --brand:#5aa0ff;--brand2:#00f5d4;--accent:#a78bfa;--border:#1f2a44;--rad:18px;--shadow:0 10px 30px rgba(0,0,0,.45);
  --ring:conic-gradient(from 0deg, var(--brand), var(--brand2), var(--accent), var(--brand));
  --glow: 1; --motion: 1;
}
:root.light{
  --bg:#f6f9ff;--bg2:#eef3ff;--glass:#ffffffcc;--text:#0b1220;--muted:#4b5568;
  --brand:#1e66ff;--brand2:#00c2a8;--accent:#7c3aed;--border:#d7def3;--shadow:0 8px 20px rgba(28,43,76,.15);
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
a{color:inherit;text-decoration:none}

/* ============= BACKDROPS ============= */
.backdrop{position:fixed;inset:0;z-index:-4;pointer-events:none;animation:hue calc(14s*var(--motion)) ease-in-out infinite alternate;filter:saturate(115%);
background:
 radial-gradient(1200px 800px at 20% -10%, rgba(90,160,255,.25), transparent 60%),
 radial-gradient(900px 600px at 90% 10%, rgba(0,245,212,.18), transparent 60%),
 radial-gradient(1000px 700px at 50% 110%, rgba(167,139,250,.16), transparent 60%),
 linear-gradient(180deg, rgba(15,23,42,.9), rgba(11,18,32,1))}
@keyframes hue{from{filter:hue-rotate(0) saturate(110%)}to{filter:hue-rotate(25deg) saturate(125%)}}
#stars{position:fixed;inset:0;z-index:-3;opacity:.35}
.orb{position:absolute;border-radius:50%;filter:blur(38px);opacity:calc(.35*var(--glow));z-index:-2;will-change:transform;transition:transform .25s ease-out}
.orb.one{top:-120px;left:-80px;width:380px;height:380px;background:radial-gradient(circle at 30% 30%,#5aa0ff,transparent 60%)}
.orb.two{right:-120px;top:20vh;width:420px;height:420px;background:radial-gradient(circle at 60% 40%,#00f5d4,transparent 60%)}
.spotlight{position:fixed;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(600px 400px at var(--mx,50%) var(--my,30%), rgba(90,160,255,.12), transparent 60%)}
.noise{position:fixed;inset:0;pointer-events:none;opacity:.08;mix-blend-mode:soft-light;z-index:-1;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity=".5"/></svg>')}
#scrollProgress{position:fixed;inset:0 auto auto 0;height:3px;background:linear-gradient(90deg,var(--brand),var(--brand2),var(--accent));width:0;z-index:100}
#cursorAura{position:fixed;left:0;top:0;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;border:1px solid rgba(255,255,255,.45);box-shadow:0 0 30px rgba(255,255,255,.15);pointer-events:none;z-index:99;transition:width .15s ease,height .15s ease,opacity .2s}

/* ============= LAYOUT / NAV ============= */
.wrap{max-width:1240px;margin:0 auto;padding:0 24px}
header{position:sticky;top:0;z-index:60;backdrop-filter:saturate(160%) blur(10px);background:linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.55));border-bottom:1px solid var(--border)}
.nav{display:flex;align-items:center;justify-content:space-between;height:78px}
.brand{display:flex;align-items:center;gap:14px;font-weight:800;letter-spacing:.3px;font-size:20px}
.brand .ring{position:relative;height:56px;width:56px;border-radius:14px;background:linear-gradient(180deg,#101b33,#0b1427);display:grid;place-items:center;box-shadow:0 6px 20px rgba(0,0,0,.35);overflow:hidden}
.brand .ring::after{content:"";position:absolute;inset:-2px;border-radius:16px;padding:2px;background:var(--ring);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:borderSpin calc(8s*var(--motion)) linear infinite}
@keyframes borderSpin{to{transform:rotate(360deg)}}
.brand img{height:34px;width:34px;border-radius:8px;object-fit:contain}
.nav a,.nav button.link{color:var(--text);margin-left:22px;font-weight:700;opacity:.92;background:none;border:0;cursor:pointer;position:relative}
.nav a::after,.nav button.link::after{content:"";position:absolute;left:0;right:0;bottom:-10px;height:2px;transform:scaleX(0);transform-origin:left;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:transform .25s ease}
.nav a:hover::after,.nav button.link:hover::after{transform:scaleX(1)}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.05);font-size:12px}
#navAvatar{width:28px;height:28px;border-radius:8px;margin-left:8px;border:1px solid var(--border);object-fit:cover;display:none}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:14px;border:1px solid transparent;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#07111f;font-weight:800;box-shadow:var(--shadow);position:relative;overflow:hidden;transition:transform .15s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-2px);box-shadow:0 14px 36px rgba(0,0,0,.5)}
.btn:active{transform:translateY(0)}
.btn::after{content:"";position:absolute;inset:-1px;background:linear-gradient(90deg,rgba(255,255,255,.35),transparent 40%,transparent);transform:translateX(-100%);transition:transform .8s cubic-bezier(.19,1,.22,1)}
.btn:hover::after{transform:translateX(0)}
.btn.outline{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn.small{padding:8px 12px;border-radius:10px;font-weight:700}
.btn[data-ripple]::before{content:"";position:absolute;border-radius:50%;transform:scale(0);background:rgba(255,255,255,.35);width:10px;height:10px;opacity:.6;pointer-events:none}
.btn[data-ripple].animate::before{animation:ripple calc(.55s*var(--motion)) ease-out}
@keyframes ripple{from{transform:scale(0);opacity:.6}to{transform:scale(28);opacity:0}}
.magnetic{transition:transform .12s ease}

/* Sections */
section{padding:90px 0}
.eyebrow{display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.06);border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-size:13px;color:var(--muted)}
.hero{text-align:center;position:relative;overflow:hidden}
.hero h1{margin:18px auto 10px;font-size:clamp(42px,6.3vw,74px);line-height:1.05;letter-spacing:-.02em;max-width:980px}
.grad{background:linear-gradient(90deg,var(--brand),var(--brand2),var(--accent));-webkit-background-clip:text;background-clip:text;color:transparent;animation:shine calc(8s*var(--motion)) linear infinite}
@keyframes shine{0%{filter:brightness(1)}50%{filter:brightness(1.15)}100%{filter:brightness(1)}}
.hero p{margin:0 auto;max-width:860px;color:var(--muted);font-size:clamp(16px,1.6vw,20px)}
.hero-cta{margin-top:26px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

/* Cards */
.section-title{font-size:36px;text-align:center;margin:0 auto 16px;letter-spacing:-.01em}
.section-lead{max-width:780px;margin:0 auto;text-align:center;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:36px}
.card{position:relative;background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);padding:26px;box-shadow:var(--shadow);transform:translateY(0);transition:transform .35s ease,border-color .35s ease,box-shadow .35s ease;will-change:transform;overflow:hidden}
.card:hover{transform:translateY(-6px);border-color:rgba(90,160,255,.45);box-shadow:0 16px 40px rgba(0,0,0,.5)}
.card::before{content:"";position:absolute;inset:-1px;border-radius:inherit;padding:1px;background:conic-gradient(from var(--ang,0deg),var(--brand),var(--brand2),var(--accent),var(--brand));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:flow calc(10s*var(--motion)) linear infinite}
@keyframes flow{to{--ang:360deg}}
.icon{display:inline-flex;align-items:center;justify-content:center;height:48px;width:48px;border-radius:12px;background:linear-gradient(180deg,rgba(90,160,255,.18),rgba(0,245,212,.12));border:1px solid var(--border);margin-bottom:12px}
.icon svg{width:26px;height:26px;opacity:.9}

/* Chat */
.chat-wrap{display:grid;grid-template-columns:1.15fr .85fr;gap:26px;align-items:stretch;margin-top:40px}
.chat{display:flex;flex-direction:column;background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);box-shadow:var(--shadow);overflow:hidden}
.chat-header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
.chat-header img{height:28px;width:28px;border-radius:8px}
.chat-header .title{font-weight:800}
.model-select{margin-left:auto;display:flex;gap:10px;align-items:center}
.select{appearance:none;background:transparent;color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px}
.msgs{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:14px}
.msg{display:flex;gap:12px;animation:bubbleIn calc(.28s*var(--motion)) ease-out}
@keyframes bubbleIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.avatar{flex:0 0 36px;height:36px;width:36px;border-radius:10px;background:#0b162a;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.msg.user .avatar{background:linear-gradient(180deg,#122244,#1a2c50)}
.bubble{background:#0b162acc;border:1px solid var(--border);border-radius:14px;padding:12px 14px;max-width:80%;line-height:1.5}
.msg.user .bubble{background:linear-gradient(180deg,#12213d,#122547)}
.msg.assistant .avatar{background:#0b162a}
.typing{display:inline-block;min-width:38px}
.typing i{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9fb0cf;opacity:.6;animation:tdot calc(1s*var(--motion)) infinite}
.typing i:nth-child(2){animation-delay:.15s}.typing i:nth-child(3){animation-delay:.3s}
@keyframes tdot{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-3px)}}
.composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));align-items:flex-start}
#meThumb{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);object-fit:cover}
.composer textarea{flex:1;min-height:46px;max-height:160px;resize:vertical;background:#0b162a;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 14px}
.composer button{white-space:nowrap}
.hint{font-size:12px;color:var(--muted);padding:0 12px 12px}
.panel{background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);box-shadow:var(--shadow);padding:22px}
.panel h4{margin:0 0 8px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--muted);margin:4px 6px 0 0;cursor:pointer}

/* History */
#threads a{display:block;padding:10px 12px;border:1px solid var(--border);border-radius:12px;margin-top:8px;background:rgba(255,255,255,.03)}
#threads a.active{border-color:rgba(90,160,255,.55); box-shadow:0 8px 24px rgba(0,0,0,.35); background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02))}
#threads .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
#threads small{color:var(--muted)}

/* Shop */
.products{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:36px}
.prod{background:var(--glass);border:1px solid var(--border);border-radius:var(--rad);padding:22px;box-shadow:var(--shadow);transition:transform .25s}
.prod:hover{transform:translateY(-4px)}
.prod h4{margin:8px 0 6px}
.price{font-size:22px;font-weight:800}

/* Footer */
footer{border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));padding:28px 0;color:var(--muted)}
.foot{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}

/* Utilities / Modals / FAB */
.reveal{opacity:1;transform:none}
.js .reveal{opacity:0;transform:translateY(14px);transition:opacity .6s ease,transform .6s ease}
.js .reveal.visible{opacity:1;transform:none}
.loader{width:100%;height:6px;background:#0b162a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.loader>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .2s ease}
.banner{background:#162136;border:1px solid var(--border);padding:12px 14px;border-radius:12px;margin:10px 0;color:#cbd5e1}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#0b162a;border:1px solid var(--border);padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);display:none}
.toast.show{display:block}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:80}
.modal .box{background:var(--glass);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px;min-width:320px;max-width:560px}
.modal input,.modal textarea,.modal select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b162a;color:var(--text);margin:8px 0}
#toTop{position:fixed;right:18px;bottom:18px;width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand),var(--brand2));border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);cursor:pointer;z-index:60;opacity:0;transform:translateY(20px);transition:opacity .25s, transform .25s}
#toTop.show{opacity:1;transform:none}

/* Command palette */
#palette{display:none}
#palette.show{display:flex}
.palette-list button{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.03);margin-top:8px}

/* Responsive */
@media (max-width:980px){
  .grid{grid-template-columns:1fr}
  .chat-wrap{grid-template-columns:1fr}
  .products{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <div id="scrollProgress"></div>
  <div id="cursorAura"></div>
  <div class="backdrop"></div>
  <div class="orb one"></div><div class="orb two"></div>
  <div class="spotlight"></div>
  <div class="noise"></div>
  <canvas id="stars"></canvas>

  <header>
    <div class="wrap nav">
      <div class="brand">
        <div class="ring"><img src="logo.png" alt="KR.AI"/></div>
        <span>KR.AI</span>
      </div>
      <nav class="right">
        <a href="#features">Features</a>
        <a href="#chat">AI Chat</a>
        <a href="#shop">Shop</a>
        <a href="#faq">FAQ</a>
        <span id="proBadge" class="badge" style="display:none">Pro account</span>
        <button id="authBtn" class="link">Sign in</button>
        <img id="navAvatar" alt="me"/>
        <button id="settingsBtn" class="link">Settings</button>
        <a id="modeToggle" href="#" aria-label="Toggle theme" style="margin-left:6px">🌙</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero wrap">
      <span class="eyebrow reveal">Fully custom. Built from zero.</span>
      <h1 class="reveal"><span class="grad">KR.AI</span> — custom AI by <b>Karol Rutkowski</b></h1>
      <p class="reveal">Glass UI, parallax, micro-interactions, flowing borders and token streaming from a local model. No third-party brand names in the UI.</p>
      <div class="hero-cta reveal">
        <a class="btn magnetic" href="#chat" id="jumpToChat" data-ripple>Open AI Chat</a>
        <a class="btn outline magnetic" href="#features" data-ripple>Explore features</a>
      </div>
      <div id="gpuBanner" class="wrap" style="max-width:820px;margin:20px auto 0"></div>
    </section>

    <!-- FEATURES -->
    <section id="features" class="wrap">
      <h2 class="section-title reveal">Everything that matters</h2>
      <p class="section-lead reveal">100% custom interface. Local model with graceful demo fallback.</p>
      <div class="grid">
        <article class="card reveal">
          <div class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12h7l-2 9 13-13h-7l2-9-13 13z" stroke-width="1.5"/></svg></div>
          <h3>Real-time streaming</h3><p>Streams live, then auto-formats to clean paragraphs & bullet points.</p>
        </article>
        <article class="card reveal">
          <div class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="8" stroke-width="1.5"/><path d="M12 4v8l5 3" stroke-width="1.5"/></svg></div>
          <h3>Premium design</h3><p>Flowing borders, spotlight, noise texture, magnetic buttons.</p>
        </article>
        <article class="card reveal">
          <div class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="7" height="14" rx="2" stroke-width="1.5"/><rect x="14" y="5" width="7" height="14" rx="2" stroke-width="1.5"/></svg></div>
          <h3>Switchable engines</h3><p>Core (fast), Ultra (quality), Fusion (two-pass refine). Toggle live.</p>
        </article>
      </div>
    </section>

    <!-- CHAT -->
    <section id="chat" class="wrap">
      <h2 class="section-title reveal">AI Chat</h2>
      <p class="section-lead reveal">Runs locally with WebGPU. If unavailable, Demo Mode simulates streaming so the UI always works.</p>

      <div class="chat-wrap">
        <div class="chat reveal" id="chatBox">
          <div class="chat-header">
            <img src="logo.png" alt="KR"/>
            <div class="title">KR Assistant</div>
            <div class="model-select">
              <label class="muted" for="engine">Engine</label>
              <select id="engine" class="select">
                <option value="core" selected>Core (Local Fast)</option>
                <option value="ultra" data-pro>Ultra (Local Quality)</option>
                <option value="fusion" data-pro>Fusion (Two-Pass)</option>
              </select>
              <label class="muted" for="model">Model</label>
              <select id="model" class="select">
                <option value="llama1b" selected>Llama-3.2-1B (light)</option>
              </select>
            </div>
          </div>

          <div style="padding:12px 18px;border-bottom:1px solid var(--border)">
            <div class="loader"><i id="progressBar"></i></div>
            <div id="modelStatus" class="hint">Model not loaded yet.</div>
          </div>

          <div class="msgs" id="msgs"></div>

          <div class="composer">
            <img id="meThumb" alt="me"/>
            <textarea id="input" placeholder="Type your message… (Shift+Enter = new line)"></textarea>
            <button class="btn magnetic" id="send" data-ripple>Send</button>
            <button class="btn outline magnetic" id="stop" title="Stop" data-ripple>Stop</button>
          </div>
          <div class="hint">Ask “who created you / who made you” for the custom answer.</div>
        </div>

        <aside class="panel reveal" id="historyPanel">
          <h4><img src="logo.png" alt="logo" class="mini" style="height:20px;width:20px;border-radius:6px;object-fit:contain">  Chat History</h4>
          <div id="threads"></div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small outline magnetic" id="newChat" data-ripple>New chat</button>
            <button class="btn small outline magnetic" id="renameChat" data-ripple>Rename</button>
            <button class="btn small outline magnetic" id="deleteChat" data-ripple>Delete</button>
            <button class="btn small outline magnetic" id="exportChat" data-ripple>Export JSON</button>
            <label class="btn small outline magnetic" for="importFile" data-ripple style="cursor:pointer">Import JSON<input id="importFile" type="file" accept="application/json" style="display:none"/></label>
          </div>

          <h4 style="margin-top:16px">Quick prompts</h4>
          <div>
            <span class="chip ex">Write a hero section for “KR.AI”.</span>
            <span class="chip ex">Give 6 catchy taglines.</span>
            <span class="chip ex">Explain growth mindset in 3 bullets.</span>
            <span class="chip ex">Draft a friendly payment reminder email.</span>
          </div>

          <h4 style="margin-top:16px">Accent</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small outline setAccent" data-a="#5aa0ff,#00f5d4,#a78bfa">Default</button>
            <button class="btn small outline setAccent" data-a="#ff6b6b,#feca57,#48dbfb">Sunset</button>
            <button class="btn small outline setAccent" data-a="#22d3ee,#14b8a6,#8b5cf6">Neon</button>
            <button class="btn small outline setAccent" data-a="#34d399,#fbbf24,#60a5fa">Tropical</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- SHOP -->
    <section id="shop" class="wrap">
      <h2 class="section-title reveal">Shop · Upgrade to Pro</h2>
      <p class="section-lead reveal">Buy once. Pro unlocks Ultra & Fusion engines and extra themes for your account.</p>

      <div class="products">
        <div class="prod reveal">
          <div class="badge">Starter</div>
          <h4>Core Access</h4>
          <p>Use the fast local engine for personal work.</p>
          <div class="price">Free</div>
          <div style="margin-top:10px"><a class="btn small outline magnetic" href="#chat" data-ripple>Use Core</a></div>
        </div>

        <div class="prod reveal">
          <div class="badge">Pro</div>
          <h4>Ultra + Fusion</h4>
          <p>Unlock both advanced engines and themes. One-time purchase.</p>
          <div class="price">€9.99</div>
          <div class="shop" style="margin-top:10px">
            <form id="paypalForm" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
              <input type="hidden" name="cmd" value="_xclick">
              <input type="hidden" name="business" value="02rrutkowski@gmail.com">
              <input type="hidden" name="item_name" value="KR.AI Pro Access">
              <input type="hidden" name="amount" value="9.99">
              <input type="hidden" name="currency_code" value="EUR">
              <input type="hidden" name="return" id="ppReturn" value="">
              <input type="hidden" name="cancel_return" id="ppCancel" value="">
              <button class="btn small magnetic" type="submit" data-ripple>Buy with PayPal</button>
            </form>
          </div>
        </div>

        <div class="prod reveal">
          <div class="badge">Add-ons</div>
          <h4>Brand Kit</h4>
          <p>Logo variants (SVG/PNG), palette & type presets by KR.</p>
          <div class="price">Coming soon</div>
          <button class="btn small outline" disabled>Waitlist</button>
        </div>
      </div>

      <div class="banner" style="margin-top:14px">
        For automatic unlock after PayPal, open this file via a local web server (e.g. <code>python -m http.server 8080</code>).
        We return to <code>?paid=1</code> and bind Pro to the signed-in account.
      </div>
    </section>

    <!-- FAQ / NEWSLETTER -->
    <section id="faq" class="wrap">
      <h2 class="section-title reveal">FAQ</h2>
      <div class="grid" style="margin-top:4px">
        <div class="card reveal">
          <h3>Does this use other AI providers?</h3>
          <p>No. It’s a custom interface that runs a small open-source model locally with WebGPU. No brand names in the UI.</p>
        </div>
        <div class="card reveal">
          <h3>What if WebGPU isn’t available?</h3>
          <p>It switches to Demo Mode (simulated streaming) so you can still test everything.</p>
        </div>
        <div class="card reveal">
          <h3>How does Pro unlock work?</h3>
          <p>You must be signed in. After PayPal returns with <code>?paid=1</code>, Pro is saved to your account and persists across reloads on this device.</p>
        </div>
      </div>

      <div class="grid" style="margin-top:22px">
        <div class="card reveal">
          <h3>Newsletter</h3>
          <p>Get updates. Local only; your email is never sent anywhere in this demo.</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;position:relative;z-index:1">
            <input id="nlEmail" autocomplete="off" type="email" placeholder="your@email" style="flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b162a;color:var(--text)"/>
            <button id="nlJoin" class="btn magnetic" data-ripple>Join</button>
          </div>
          <div class="hint" id="nlStatus"></div>
        </div>
        <div class="card reveal">
          <h3>Shortcuts</h3>
          <p>Open command palette with <b>Ctrl/⌘+K</b>. Use it to jump anywhere quickly.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <a class="btn small outline magnetic" href="#features" data-ripple>Features</a>
            <a class="btn small outline magnetic" href="#chat" data-ripple>Chat</a>
            <a class="btn small outline magnetic" href="#shop" data-ripple>Shop</a>
            <a class="btn small outline magnetic" href="#faq" data-ripple>FAQ</a>
          </div>
        </div>
        <div class="card reveal">
          <h3>Theme</h3>
          <p>Toggle light/dark and pick an accent in Chat → Accent.</p>
          <div><button class="btn small outline magnetic" id="toggleTheme" data-ripple>Toggle theme</button></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap foot">
      <div class="foot-left"><img src="logo.png" class="mini" alt="logo" style="height:24px;width:24px;border-radius:6px;object-fit:contain"/><span>© 2025 KR.AI — built by Karol Rutkowski</span></div>
      <div class="foot-right"><a href="#">Privacy</a><a href="#">Terms</a><a href="#">Contact</a></div>
    </div>
  </footer>

  <div id="toTop" title="Back to top">^</div>
  <div class="toast" id="toast"></div>

  <!-- Auth Modal (avatar on sign-up) -->
  <div class="modal" id="authModal">
    <div class="box">
      <h3 id="authTitle">Sign in</h3>
      <div class="tabs" style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn small outline magnetic" id="tabSignIn" data-ripple>Sign in</button>
        <button class="btn small outline magnetic" id="tabSignUp" data-ripple>Create account</button>
      </div>
      <div id="signInForm">
        <input id="siEmail" type="email" placeholder="Email"/>
        <input id="siPass" type="password" placeholder="Password"/>
        <button class="btn magnetic" id="doSignIn" data-ripple>Sign in</button>
      </div>
      <div id="signUpForm" style="display:none">
        <input id="suName" type="text" placeholder="Full name"/>
        <input id="suEmail" type="email" placeholder="Email"/>
        <input id="suPass" type="password" placeholder="Password (min 6)"/>
        <label style="font-size:12px;color:var(--muted)">Profile photo (optional)</label>
        <input id="suAvatar" type="file" accept="image/*"/>
        <button class="btn magnetic" id="doSignUp" data-ripple>Create account</button>
      </div>
      <div style="margin-top:8px;text-align:right"><button class="btn small outline magnetic" id="closeAuth" data-ripple>Close</button></div>
    </div>
  </div>

  <!-- Generic Dialog (rename / confirm / settings) -->
  <div class="modal" id="dialog">
    <div class="box">
      <h3 id="dialogTitle">Dialog</h3>
      <div id="dialogBody" style="margin-top:6px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn small outline magnetic" id="dialogCancel" data-ripple>Cancel</button>
        <button class="btn small magnetic" id="dialogOk" data-ripple>OK</button>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="modal" id="palette">
    <div class="box" style="width:560px;max-width:90%">
      <h3>Quick actions</h3>
      <div class="palette-list" style="margin-top:6px">
        <button data-go="#features">Go to Features</button>
        <button data-go="#chat">Go to Chat</button>
        <button data-go="#shop">Go to Shop</button>
        <button data-go="#faq">Go to FAQ</button>
      </div>
      <div style="margin-top:8px;text-align:right"><button class="btn small outline magnetic" id="closePalette" data-ripple>Close</button></div>
    </div>
  </div>

<script>
/* ===== Helpers: image -> dataURL (resized) ===== */
function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}
async function resizeImage(file,max=128){
  const url=await fileToDataURL(file);
  const img=new Image(); img.src=url; await img.decode();
  const c=document.createElement('canvas'); const scale=max/Math.max(img.width,img.height);
  c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
  const ctx=c.getContext('2d'); ctx.imageSmoothingQuality='high'; ctx.drawImage(img,0,0,c.width,c.height);
  return c.toDataURL('image/png',0.92);
}

/* ===== Canvas stars + comet ===== */
(function(){
  const c=document.getElementById('stars'); const dpr=window.devicePixelRatio||1; const ctx=c.getContext('2d');
  let w,h,stars=[]; const N=180; function resize(){w=innerWidth;h=innerHeight;c.width=w*dpr;c.height=h*dpr;c.style.width=w+'px';c.style.height=h+'px';ctx.setTransform(dpr,0,0,dpr,0,0)} resize(); addEventListener('resize',resize);
  for(let i=0;i<N;i++) stars.push({x:Math.random()*w,y:Math.random()*h,s:Math.random()*1.6+0.2,v:Math.random()*0.15+0.02});
  let t=0, comet={x:Math.random()*w,y:-20,s:1.6};
  (function loop(){ctx.clearRect(0,0,w,h); ctx.globalAlpha=.9;
    for(const st of stars){ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fill(); st.y+=st.v; if(st.y>h+5){st.y=-5; st.x=Math.random()*w}}
    if((t++%420)===0){ comet={x:Math.random()*w,y:-30,s:1.8}; }
    if(comet.y<h+40){ ctx.globalAlpha=.8; ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.arc(comet.x,comet.y,comet.s,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(comet.x,comet.y); ctx.lineTo(comet.x-40,comet.y-18); ctx.stroke(); comet.y+=1.2; comet.x+=.2; }
    requestAnimationFrame(loop);
  })();
})();

/* Parallax / spotlight / aura / progress */
document.addEventListener('mousemove',(e)=>{
  const {innerWidth:w, innerHeight:h}=window;
  const dx=(e.clientX/w-.5)*2, dy=(e.clientY/h-.5)*2;
  document.querySelectorAll('.orb').forEach((o,i)=>o.style.transform=`translate(${dx*(i?24:16)}px,${dy*(i?18:12)}px)`);
  document.documentElement.style.setProperty('--mx', e.clientX+'px');
  document.documentElement.style.setProperty('--my', e.clientY+'px');
  const aura=document.getElementById('cursorAura'); aura.style.left=e.clientX+'px'; aura.style.top=e.clientY+'px';
});
document.addEventListener('mousedown',()=>{const a=document.getElementById('cursorAura'); a.style.width='28px'; a.style.height='28px';});
document.addEventListener('mouseup',()=>{const a=document.getElementById('cursorAura'); a.style.width='18px'; a.style.height='18px';});
document.addEventListener('scroll', ()=>{
  const sp=document.getElementById('scrollProgress');
  const p = Math.min(1, (scrollY)/(document.body.scrollHeight - innerHeight));
  sp.style.width = (p*100)+'%';
  document.getElementById('toTop').classList.toggle('show', scrollY>600);
});

/* Reveal on scroll */
const io=new IntersectionObserver((es)=>es.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible'); io.unobserve(e.target)}}),{threshold:.12});
document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

/* Magnetic buttons + ripple */
document.querySelectorAll('.magnetic').forEach(btn=>{
  btn.addEventListener('mousemove',e=>{const r=btn.getBoundingClientRect(); const x=e.clientX-(r.left+r.width/2); const y=e.clientY-(r.top+r.height/2); btn.style.transform=`translate(${x*.06}px,${y*.06}px)`;});
  btn.addEventListener('mouseleave',()=>btn.style.transform='');
});
document.addEventListener('click',e=>{
  const b=e.target.closest('.btn[data-ripple]'); if(!b) return;
  const r=b.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  b.style.setProperty('--rx', x+'px'); b.style.setProperty('--ry', y+'px');
  b.classList.remove('animate'); void b.offsetWidth; b.classList.add('animate');
});

/* Theme toggles */
document.getElementById('modeToggle')?.addEventListener('click',(e)=>{e.preventDefault();document.documentElement.classList.toggle('light');e.currentTarget.textContent=document.documentElement.classList.contains('light')?'🌞':'🌙'});
document.getElementById('toggleTheme')?.addEventListener('click',()=>document.getElementById('modeToggle').click());

/* Command palette */
const palette=document.getElementById('palette');
document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); palette.classList.toggle('show'); }});
document.getElementById('closePalette').onclick=()=>palette.classList.remove('show');
palette.querySelectorAll('[data-go]').forEach(b=>b.addEventListener('click',()=>{document.querySelector(b.dataset.go).scrollIntoView({behavior:'smooth'}); palette.classList.remove('show');}));

/* Back to top */
document.getElementById('toTop').addEventListener('click',()=>scrollTo({top:0,behavior:'smooth'}));

/* Newsletter */
const toast = document.getElementById('toast');
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2300); }
document.getElementById('nlJoin').addEventListener('click',()=>{
  const v=document.getElementById('nlEmail').value.trim(); if(!v || !v.includes('@')){ showToast('Enter a valid email'); return; }
  localStorage.setItem('krai_newsletter', v); document.getElementById('nlStatus').textContent='Saved locally. Thanks!';
});

/* ===== Storage (localStorage + IndexedDB fallback) ===== */
const STORE='krai_users_v5', SESSION='krai_session_v5', GUEST='guest@local', SETTINGS='krai_settings_v1';
let cache={users:{}, session:null, settings:{}};
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open('krai_db_v5',1);r.onupgradeneeded=()=>{r.result.createObjectStore('kv')};r.onerror=()=>rej(r.error);r.onsuccess=()=>res(r.result)})}
async function idbGet(k){try{const db=await idbOpen();return await new Promise(s=>{const tx=db.transaction('kv');const st=tx.objectStore('kv');const req=st.get(k);req.onsuccess=()=>s(req.result?JSON.parse(req.result):null);req.onerror=()=>s(null)})}catch{return null}}
async function idbSet(k,v){try{const db=await idbOpen();return await new Promise(s=>{const tx=db.transaction('kv','readwrite');tx.objectStore('kv').put(JSON.stringify(v),k);tx.oncomplete=()=>s(true);tx.onerror=()=>s(false)})}catch{return false}}
const storage={async get(k){try{const v=localStorage.getItem(k);if(v!==null) return JSON.parse(v)}catch{} return await idbGet(k)}, async set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{} try{await idbSet(k,v)}catch{}}};
async function bootLoad(){cache.users = await storage.get(STORE) || {}; cache.session = await storage.get(SESSION) || null; cache.settings = await storage.get(SETTINGS) || {};}
function loadUsers(){return cache.users} function saveUsers(u){cache.users=u; storage.set(STORE,u)}
function getSession(){return cache.session} function setSession(s){cache.session=s; storage.set(SESSION,s)}
function currentUser(){const s=getSession(); if(!s) return null; const u=loadUsers()[s.email]; return u?{email:s.email, ...u}:null}
function isGuestUser(u){return u && u.email===GUEST}
function ensureGuest(){ if(!getSession()){ const users=loadUsers(); if(!users[GUEST]) users[GUEST]={name:'Guest',pass:null,pro:false,chats:[],lastChatId:null,avatar:null}; saveUsers(users); setSession({email:GUEST}); }}

/* ===== Settings ===== */
function applySettings(){
  const s = cache.settings || {};
  document.documentElement.style.setProperty('--motion', s.reduceMotion? '0' : '1');
  document.documentElement.style.setProperty('--glow', s.lowGlow? '.55' : '1');
  document.getElementById('stars').style.display = s.hideStars? 'none':'block';
  document.body.classList.toggle('dense', !!s.dense);
}
function openSettings(){
  const s = cache.settings || {};
  openDialog({
    title:'Settings',
    bodyHTML:`
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="st_reduce" ${s.reduceMotion?'checked':''}/> Reduce motion</label>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="st_hide" ${s.hideStars?'checked':''}/> Hide starfield</label>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="st_glow" ${s.lowGlow?'checked':''}/> Lower glow</label>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="st_dense" ${s.dense?'checked':''}/> Dense layout</label>
      <hr style="border-color:var(--border);opacity:.4;margin:12px 0">
      <label>Change profile photo</label>
      <input id="st_avatar" type="file" accept="image/*"/>
    `,
    okText:'Save',
    onConfirm:async ()=>{
      cache.settings = {
        reduceMotion: document.getElementById('st_reduce').checked,
        hideStars: document.getElementById('st_hide').checked,
        lowGlow: document.getElementById('st_glow').checked,
        dense: document.getElementById('st_dense').checked
      };
      const f=document.getElementById('st_avatar').files?.[0];
      if(f){ const data=await resizeImage(f,128); const u=currentUser(); const all=loadUsers(); all[u.email].avatar=data; saveUsers(all); reflectAvatar(); }
      storage.set(SETTINGS, cache.settings);
      applySettings();
      showToast('Settings saved');
    }
  });
}
document.getElementById('settingsBtn')?.addEventListener('click', openSettings);

/* ===== Auth (with avatar on sign-up) ===== */
const authModal=document.getElementById('authModal');
function openAuth(){authModal.style.display='flex'} function closeAuth(){authModal.style.display='none'}
document.getElementById('authBtn').addEventListener('click',()=>{
  const u=currentUser(); if(!u || isGuestUser(u)){ openAuth(); return; }
  openDialog({
    title:'Sign out',
    bodyHTML:`<p>You are signed in as <b>${u.email}</b>.</p><p>Do you want to sign out?</p>`,
    okText:'Sign out',
    onConfirm:()=>{ setSession(null); document.getElementById('authBtn').textContent='Sign in'; reflectPro(false); reflectAvatar(); ensureGuest(); renderThreads(); renderThreadMessages(); showToast('Signed out'); }
  });
});
document.getElementById('closeAuth').onclick=closeAuth;
const tabIn=document.getElementById('tabSignIn'), tabUp=document.getElementById('tabSignUp');
const signInForm=document.getElementById('signInForm'), signUpForm=document.getElementById('signUpForm'), authTitle=document.getElementById('authTitle');
tabIn.onclick=()=>{signInForm.style.display='block';signUpForm.style.display='none';authTitle.textContent='Sign in'}
tabUp.onclick=()=>{signInForm.style.display='none';signUpForm.style.display='block';authTitle.textContent='Create account'}
async function sha256(txt){const enc=new TextEncoder().encode(txt);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')}
document.getElementById('doSignUp').addEventListener('click', async ()=>{
  const name=document.getElementById('suName').value.trim();
  const email=document.getElementById('suEmail').value.trim().toLowerCase();
  const pass=document.getElementById('suPass').value;
  const avFile=document.getElementById('suAvatar').files?.[0]||null;
  if(!name||!email||pass.length<6){showToast('Fill all fields (password ≥ 6).');return}
  const users=loadUsers(); if(users[email]){showToast('Account already exists. Sign in.');return}
  let avatar=null; if(avFile){ try{avatar=await resizeImage(avFile,128);}catch{} }
  users[email]={name, pass:await sha256(pass), pro:false, chats:[], lastChatId:null, avatar};
  // migrate guest chats
  const g=users[GUEST]; if(g&&g.chats?.length){ users[email].chats=[...g.chats,...users[email].chats]; users[email].lastChatId=users[email].lastChatId||g.lastChatId; users[GUEST]={name:'Guest',pass:null,pro:false,chats:[],lastChatId:null,avatar:g.avatar||null}; }
  saveUsers(users); setSession({email}); document.getElementById('authBtn').textContent=email; closeAuth(); showToast('Account created'); reflectPro(false); reflectAvatar(); renderThreads(); renderThreadMessages();
});
document.getElementById('doSignIn').addEventListener('click', async ()=>{
  const email=document.getElementById('siEmail').value.trim().toLowerCase();
  const pass=document.getElementById('siPass').value;
  const users=loadUsers(); const u=users[email];
  if(!u){showToast('No account. Create one.');return}
  if(u.pass!==await sha256(pass)){showToast('Wrong password.');return}
  // migrate guest chats
  const g=users[GUEST]; if(g&&g.chats?.length){ users[email].chats=[...g.chats,...users[email].chats]; users[email].lastChatId=users[email].lastChatId||g.lastChatId; users[GUEST]={name:'Guest',pass:null,pro:false,chats:[],lastChatId:null,avatar:g.avatar||null}; saveUsers(users); }
  setSession({email}); document.getElementById('authBtn').textContent=email; closeAuth(); showToast('Signed in'); reflectPro(u.pro); reflectAvatar(); renderThreads(); restoreChat();
});

/* Nav / composer avatar reflect */
function reflectAvatar(){
  const u=currentUser();
  const nav=document.getElementById('navAvatar');
  const me=document.getElementById('meThumb');
  const src=u?.avatar||'';
  if(src){ nav.src=src; nav.style.display='inline-block'; me.src=src; }
  else{ nav.style.display='none'; me.src=''; }
}

/* ===== Pro unlock (PayPal) ===== */
const proBadge=document.getElementById('proBadge');
function reflectPro(isPro){
  const user=currentUser();
  proBadge.style.display = (user && (isPro||user.pro)) ? 'inline-flex' : 'none';
  document.querySelectorAll('#engine option[data-pro]').forEach(o=>{
    const allowed = (user && (isPro || user.pro));
    o.classList.toggle('lock', !allowed);
    if(!allowed){ o.textContent = o.textContent.replace(' (requires Pro)','') + ' (requires Pro)'; }
    else{ o.textContent = o.textContent.replace(' (requires Pro)',''); }
  });
}
const ppForm=document.getElementById('paypalForm');
if(ppForm){
  ppForm.addEventListener('submit',(e)=>{
    const user=currentUser();
    if(!user){ e.preventDefault(); openAuth(); showToast('Sign in before purchase.'); return; }
    const base=(location.origin && location.origin!=='null')? (location.origin+location.pathname) : '';
    document.getElementById('ppReturn').value = base? `${base}?paid=1&acct=${encodeURIComponent(user.email)}` : 'https://example.com?paid=1';
    document.getElementById('ppCancel').value = base? `${base}?paid=0` : 'https://example.com?paid=0';
  });
}
const paid=new URLSearchParams(location.search).get('paid');
const acct=new URLSearchParams(location.search).get('acct');
if(paid==='1' && acct){
  const users=loadUsers(); if(users[acct]){ users[acct].pro=true; saveUsers(users); if(currentUser()?.email===acct) reflectPro(true); showToast('Pro unlocked.'); }
  history.replaceState({},'',location.pathname);
}

/* ===== Chat storage (per account, Guest by default) ===== */
function requireAuth(){const u=currentUser(); if(!u){openAuth(); return false} return true}
function userData(){const u=currentUser(); if(!u) return null; return loadUsers()[u.email]}
function persistUserData(data){const u=currentUser(); if(!u) return; const all=loadUsers(); all[u.email]=data; saveUsers(all)}
function newThread(title){const data=userData(); if(!data) return null; const id='t'+Date.now(); const thr={id,title,created:Date.now(),msgs:[]}; data.chats.unshift(thr); data.lastChatId=id; persistUserData(data); return thr;}
function getThread(id){const data=userData(); if(!data) return null; return data.chats.find(t=>t.id===id)||null}
function currentThread(){const data=userData(); if(!data) return null; return getThread(data.lastChatId)||null}
function setCurrentThread(id){const data=userData(); if(!data) return; data.lastChatId=id; persistUserData(data)}
function fmtTime(ts){const d=new Date(ts); return d.toLocaleString();}

function renderThreads(){
  const box=document.getElementById('threads'); if(!box) return;
  const data=userData(); box.innerHTML='';
  if(!data||!data.chats.length){ box.innerHTML='<div class="hint">No chats yet.</div>'; return; }
  const activeId=data.lastChatId;
  data.chats.forEach(t=>{
    const a=document.createElement('a'); a.href="#chat";
    const last=(t.msgs[t.msgs.length-1]?.content||'').slice(0,64);
    a.innerHTML = `<div class="row"><span>${t.title || 'Untitled chat'}</span><small>${fmtTime(t.created)}</small></div><small>${last}</small>`;
    if(t.id===activeId) a.classList.add('active');
    a.onclick=(e)=>{e.preventDefault(); setCurrentThread(t.id); renderThreads(); renderThreadMessages(); document.getElementById('chat').scrollIntoView({behavior:'smooth'}); document.getElementById('input').focus();};
    box.appendChild(a);
  });
}
function addMsg(role, html){
  const msgsEl=document.getElementById('msgs');
  const row=document.createElement('div'); row.className='msg '+role;
  const av=document.createElement('div'); av.className='avatar';
  // avatar images
  if(role==='assistant'){ const img=document.createElement('img'); img.src='logo.png'; img.alt='KR'; av.appendChild(img); }
  else{ const me=currentUser(); if(me?.avatar){ const img=document.createElement('img'); img.src=me.avatar; img.alt='Me'; av.appendChild(img); } }
  const bub=document.createElement('div'); bub.className='bubble'; bub.innerHTML=html;
  row.appendChild(av); row.appendChild(bub); msgsEl.appendChild(row); msgsEl.scrollTop=msgsEl.scrollHeight; return bub;
}
function renderThreadMessages(){
  const t=currentThread(); const msgsEl=document.getElementById('msgs'); msgsEl.innerHTML='';
  if(!t){ msgsEl.innerHTML='<div class="msg assistant"><div class="avatar"><img src="logo.png" alt="KR"></div><div class="bubble">Welcome! Start a new chat from the right panel.</div></div>'; return;}
  t.msgs.forEach(m=>{
    const row=document.createElement('div'); row.className='msg '+m.role;
    const av=document.createElement('div'); av.className='avatar';
    if(m.role==='assistant'){ const img=document.createElement('img'); img.src='logo.png'; img.alt='KR'; av.appendChild(img); }
    else{ const me=currentUser(); if(me?.avatar){ const img=document.createElement('img'); img.src=me.avatar; img.alt='Me'; av.appendChild(img); } }
    const bub=document.createElement('div'); bub.className='bubble'; bub.innerHTML=(m.html||escapeHTML(m.content||'')).replace(/\n/g,'<br>');
    row.appendChild(av); row.appendChild(bub); msgsEl.appendChild(row);
  });
  msgsEl.scrollTop=msgsEl.scrollHeight;
}

/* ===== Pretty Dialogs ===== */
const dialog=document.getElementById('dialog');
const dialogTitle=document.getElementById('dialogTitle');
const dialogBody=document.getElementById('dialogBody');
const dialogOk=document.getElementById('dialogOk');
const dialogCancel=document.getElementById('dialogCancel');
function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function openDialog({title, bodyHTML, okText='OK', cancelText='Cancel', onConfirm, onCancel}={}){
  dialogTitle.textContent=title||'Dialog';
  dialogBody.innerHTML=bodyHTML||'';
  dialog.style.display='flex';
  dialogOk.textContent=okText; dialogCancel.textContent=cancelText;
  const cleanup=()=>{ dialog.style.display='none'; dialogOk.onclick=dialogCancel.onclick=null; };
  dialogOk.onclick=()=>{ try{ onConfirm&&onConfirm(); } finally{ cleanup(); } };
  dialogCancel.onclick=()=>{ onCancel&&onCancel(); cleanup(); };
}
document.getElementById('newChat').addEventListener('click',()=>{ if(!requireAuth()) return; const thr=newThread('New chat'); renderThreads(); renderThreadMessages(); document.getElementById('chat').scrollIntoView({behavior:'smooth'}); document.getElementById('input').focus(); });
document.getElementById('renameChat').addEventListener('click',()=>{
  if(!requireAuth()) return;
  const t=currentThread(); if(!t) return;
  openDialog({
    title:'Rename chat',
    bodyHTML:`<input id="renameInput" value="${escapeHTML(t.title||'Untitled chat')}" autofocus placeholder="Enter new title"/>`,
    okText:'Save',
    onConfirm:()=>{ const name=(document.getElementById('renameInput').value||'').trim()||'Untitled chat'; const data=userData(); const thr=getThread(t.id); thr.title=name; persistUserData(data); renderThreads(); }
  });
});
document.getElementById('deleteChat').addEventListener('click',()=>{
  if(!requireAuth()) return;
  const t=currentThread(); if(!t) return;
  openDialog({
    title:'Delete chat',
    bodyHTML:`<p>Delete <b>${escapeHTML(t.title||'Untitled chat')}</b>? This cannot be undone.</p>`,
    okText:'Delete',
    onConfirm:()=>{ const data=userData(); data.chats = data.chats.filter(x=>x.id!==t.id); data.lastChatId = data.chats[0]?.id || null; persistUserData(data); renderThreads(); renderThreadMessages(); }
  });
});

/* Export / Import */
document.getElementById('exportChat').addEventListener('click',()=>{
  const data=userData(); if(!data){showToast('No data'); return;}
  const blob=new Blob([JSON.stringify(data.chats,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='krai_chats.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('importFile').addEventListener('change',async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const txt=await file.text(); let arr=[]; try{arr=JSON.parse(txt)}catch{showToast('Invalid file'); return;}
  const data=userData(); if(!data) return;
  if(!Array.isArray(arr)){showToast('Invalid format'); return;}
  data.chats=[...arr,...data.chats]; data.lastChatId=data.chats[0]?.id||null; persistUserData(data); renderThreads(); renderThreadMessages(); showToast('Imported');
});

/* ===== GPU banner ===== */
function setBanner(msg){ const el=document.getElementById('gpuBanner'); if(el) el.innerHTML = `<div class="banner">${msg}</div>`; }
if(!('gpu' in navigator)) setBanner("No WebGPU detected — Demo Mode enabled. Use Chrome/Edge on a recent GPU for local AI.");
else setBanner("WebGPU detected — the model will load when you send the first message.");

/* ===== Markdown-ish formatter for readability ===== */
function mdFormat(src){
  // protect code fences
  const fences=[]; src=src.replace(/```([\\s\\S]*?)```/g,(m,code)=>{fences.push(code); return `\uFFF0${fences.length-1}\uFFF1`;});
  let html=escapeHTML(src);

  // headings
  html=html.replace(/^### (.*)$/gm,'<h4>$1</h4>')
           .replace(/^## (.*)$/gm,'<h3>$1</h3>')
           .replace(/^# (.*)$/gm,'<h2>$1</h2>');

  // lists
  html=html.replace(/(^|\n)(?:- |\* )(.+)(?=\n|$)/g,'$1<li>$2</li>');
  html=html.replace(/(?:<li>.*<\/li>)(\n<li>.*<\/li>)+/gs,(m)=>`<ul>${m}</ul>`);

  // numbered lists
  html=html.replace(/(^|\n)(\d+)\. (.+)(?=\n|$)/g,'$1<li>$2. $3</li>');
  html=html.replace(/(?:<li>\d+\. .*<\/li>)(\n<li>\d+\. .*<\/li>)+/gs,(m)=>`<ol>${m}</ol>`);

  // paragraphs
  html=html.replace(/\n{2,}/g,'</p><p>').replace(/^/,'<p>').replace(/$/,'</p>');

  // restore fences
  html=html.replace(/\uFFF0(\d+)\uFFF1/g,(m,i)=>`<pre><code>${escapeHTML(fences[i])}</code></pre>`);
  return html;
}

/* ===== AI (WebLLM) + Demo fallback ===== */
let engine=null, abort=false, demoMode=false;
const progressBar=document.getElementById('progressBar');
const modelStatus=document.getElementById('modelStatus');
const engineEl=document.getElementById('engine');
const inputEl=document.getElementById('input');
const sendBtn=document.getElementById('send');
const stopBtn=document.getElementById('stop');

const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
async function* demoStream(text){ for(let i=0;i<text.length;i++){ if(abort) return; yield text[i]; await sleep(6);} }
function cfg(mode){ if(mode==='core') return {temperature:.7, top_p:.95, max_tokens:512}; if(mode==='ultra') return {temperature:.35, top_p:.9, max_tokens:768}; return {temperature:.5, top_p:.9, max_tokens:640}; }
function isWhoCreatedYou(s){ const q=s.toLowerCase(); return q.includes("who created you")||q.includes("who made you"); }
const CUSTOM_CREATOR_REPLY = `oke and who made you?
I was created by Meta AI, a team of AI researchers at Meta Platforms, Inc. (formerly Facebook) to assist and communicate with users.
(And customized by Karol Rutkowski for this website.)`;

async function ensureEngine(){
  if(engine || demoMode) return;
  if(!('gpu' in navigator)){ demoMode=true; modelStatus.textContent="Demo Mode (no WebGPU)."; progressBar.style.width="100%"; return; }
  try{
    const { CreateMLCEngine } = await import("https://esm.run/@mlc-ai/web-llm");
    const modelId="Llama-3.2-1B-Instruct-q4f16_1-MLC";
    modelStatus.textContent=`Loading model: ${modelId}`;
    const initProgressCallback=(p)=>{ progressBar.style.width=Math.max(8,Math.floor((p.progress||0)*100))+'%'; modelStatus.textContent=p.text||'Loading model…'; };
    engine=await CreateMLCEngine(modelId,{initProgressCallback});
    progressBar.style.width="100%"; modelStatus.textContent="Model loaded. Ready.";
  }catch(e){ demoMode=true; modelStatus.textContent="Demo Mode (offline)."; progressBar.style.width="100%"; }
}
async function* localStream(messages, config){
  const resp=await engine.chat.completions.create({messages, stream:true, temperature:config.temperature, top_p:config.top_p, max_tokens:config.max_tokens});
  for await (const chunk of resp){ const d=chunk?.choices?.[0]?.delta?.content||""; if(d) yield d; }
}

/* Send + persist with typing indicator and final formatting */
async function handleSend(){
  const u=currentUser(); if(!u){openAuth(); return;}
  let data=userData(); if(!data) return;
  let thr=currentThread(); if(!thr){ thr=newThread('New chat'); data=userData(); }
  const val=inputEl.value.trim(); if(!val) return;
  inputEl.value=''; sendBtn.disabled=true; stopBtn.disabled=false; abort=false;

  thr.title = thr.title==='New chat' && val ? val.slice(0,60) : (thr.title||val.slice(0,60));
  thr.msgs.push({role:'user', content:val, ts:Date.now()}); persistUserData(data);

  addMsg('user', escapeHTML(val).replace(/\n/g,'<br>'));
  const out=addMsg('assistant','<span class="typing"><i></i><i></i><i></i></span>');

  try{
    await ensureEngine();

    if(isWhoCreatedYou(val)){
      let acc=''; out.innerHTML='';
      for await (const ch of demoStream(CUSTOM_CREATOR_REPLY)){ if(abort) break; acc+=ch; out.textContent=acc; }
      out.innerHTML = mdFormat(acc);
      thr.msgs.push({role:'assistant', content:acc, html:out.innerHTML, ts:Date.now()}); persistUserData(data); renderThreads(); return;
    }

    const mode=engineEl.value;
    const isPro=currentUser()?.pro;
    if((mode==='ultra'||mode==='fusion') && !isPro){
      const msg="[Pro required] Go to Shop to upgrade.";
      out.textContent=msg; thr.msgs.push({role:'assistant', content:msg, html:escapeHTML(msg), ts:Date.now()}); persistUserData(data); return;
    }

    const base=[{role:'system',content:'You are a helpful, concise assistant for this website. Keep answers crisp and prefer short paragraphs and bullet points.'},{role:'user',content:val}];

    let acc=''; out.innerHTML='';
    if(demoMode){
      const demo=`Demo reply (no WebGPU or offline):\n\nYou said: "${val}"\n\nThis is simulated streaming so you can test the UI without providers or keys.`;
      for await (const ch of demoStream(demo)){ if(abort) break; acc+=ch; out.textContent=acc; }
    }else if(mode==='fusion'){
      for await (const ch of localStream(base, cfg('core'))){ if(abort) break; acc+=ch; out.textContent=acc; }
      if(!abort){
        const refine={role:'user',content:'Refine your last answer: clearer, shorter, use bullet points where helpful.'};
        acc+="\n\n— Refining … —\n"; out.textContent=acc;
        for await (const ch of localStream([...base,{role:'assistant',content:acc},refine], cfg('ultra'))){ if(abort) break; acc+=ch; out.textContent=acc; }
      }
    }else{
      for await (const ch of localStream(base, cfg(mode))){ if(abort) break; acc+=ch; out.textContent=acc; }
    }

    // final pretty format
    out.innerHTML = mdFormat(acc);
    thr.msgs.push({role:'assistant', content:acc, html:out.innerHTML, ts:Date.now()}); persistUserData(data);
  }catch(err){
    const msg='⚠️ '+(err?.message||String(err)); out.textContent=msg; thr.msgs.push({role:'assistant', content:msg, html:escapeHTML(msg), ts:Date.now()}); persistUserData(data);
  }finally{
    sendBtn.disabled=false; stopBtn.disabled=true; renderThreads();
    document.getElementById('chat').scrollIntoView({behavior:'smooth'});
  }
}
document.getElementById('send').addEventListener('click', handleSend);
document.getElementById('stop').addEventListener('click', ()=>{ abort=true; try{ engine?.interruptGenerate?.(); }catch{} document.getElementById('stop').disabled=true; });
document.getElementById('input').addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }});
document.querySelectorAll('.ex').forEach(ch=>ch.addEventListener('click',()=>{ document.getElementById('input').value=ch.textContent; document.getElementById('input').focus(); }));
document.getElementById('jumpToChat').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('chat').scrollIntoView({behavior:'smooth'}); });

/* Accent picker */
document.querySelectorAll('.setAccent').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const [a,b,c]=btn.dataset.a.split(',');
    document.documentElement.style.setProperty('--brand', a);
    document.documentElement.style.setProperty('--brand2', b);
    document.documentElement.style.setProperty('--accent', c);
    document.documentElement.style.setProperty('--ring', `conic-gradient(from 0deg, ${a}, ${b}, ${c}, ${a})`);
    showToast('Accent updated');
  });
});

/* ===== Init ===== */
(async function init(){
  try{ if(navigator?.storage?.persist) await navigator.storage.persist(); }catch{}
  await bootLoad(); ensureGuest();
  applySettings();
  const u=currentUser();
  document.getElementById('authBtn').textContent = (u && !isGuestUser(u)) ? u.email : 'Sign in';
  reflectPro(u?.pro); reflectAvatar();
  renderThreads(); restoreChat();
})();
</script>
</body>
</html>
